{"version":3,"sources":["../../lib/precompile.js"],"names":["uglifyjs","require","prefixer","tokenizer","parser","compiler","blocks","codegen","wrap","compiled","replace","compileFallback","source","opts","prefixed","tokens","parsed","fnAst","ast","code","minified","minify","wrapped","result","error","compile","e","console","warn","process","platform","versions","modules","precompile","options","callback","promise","Promise","try","Object","assign","defaults","Error","unsafe","native","then","nextTick","err","isNative","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst uglifyjs = require('uglify-js');\n\nconst prefixer = require('./compiler/prefixer');\nconst tokenizer = require('./compiler/tokenizer');\nconst parser = require('./compiler/parser');\nconst compiler = require('./compiler/compiler');\nconst blocks = require('./compiler/blocks');\nconst codegen = require('./compiler/codegen');\n\nfunction wrap(compiled) {\n  return `\n(function (factory) {\n  if (typeof module === 'object' && module.exports) {\n    module.exports = factory();\n  } else if (typeof define === 'function' && define.amd) {\n    define(factory);\n  }\n})(function () {\n  ${compiled.replace(/\\n/g, '\\n\\t')}\n\n  return compiled;\n});\n  `;\n}\n\nfunction compileFallback(source, opts) {\n  const prefixed = prefixer(source);\n  const tokens = tokenizer(prefixed);\n  const parsed = parser(tokens);\n  const fnAst = compiler(parsed, opts);\n  const ast = blocks(fnAst);\n  const code = codegen(ast, { minified: opts.minify });\n\n  return wrap(code);\n}\n\nfunction minify(wrapped) {\n  const result = uglifyjs.minify(wrapped);\n\n  if (result.error) {\n    throw result.error;\n  }\n\n  return result.code;\n}\n\nconst compile = (() => {\n  try {\n    // eslint-disable-next-line global-require, import/no-unresolved\n    return require('../../rust/benchpress-rs').compile;\n  } catch (e) {\n    /* eslint-disable no-console */\n    console.warn('[benchpressjs] Unable to build or find a suitable native module, falling back to JS version.');\n    console.warn('[benchpressjs] This will result in much longer template build times.');\n    console.warn(`[benchpressjs] prebuilt module failed to load: ${process.platform}_${process.versions.modules}`);\n\n    if (process.platform === 'win32') {\n      console.warn('[benchpressjs] On Windows, make sure the VS2015 Redistributable binaries are installed');\n    }\n\n    console.warn('[benchpressjs] If the above module is not available at `node_modules/benchpressjs/rust/benchpress-rs/pre-built/`,');\n    console.warn('[benchpressjs] you can manually build benchpress-rs following the instructions here:');\n    console.warn('[benchpressjs] `https://github.com/benchpressjs/benchpressjs/blob/master/README.md#manually-building-native-module`');\n\n    /* eslint-enable no-console */\n    return compileFallback;\n  }\n})();\n\n/**\n * Precompile a benchpress template\n * - `precompiled(source, options): Promise<string>`\n * - `precompile(source, options, callback) => callback(err, output)`\n * - `precompile({ source, ...options }, callback) => callback(err, output)`\n *\n * @param {string} source - Template source\n * @param {Object} options\n * @param {boolean} [options.minify = false] - Output minified code\n * @param {boolean} [options.unsafe = false] - Disable safety checks, will throw on misshapen data\n * @param {boolean} [options.native = true] - Use the native Rust compiler if available\n * @param {function} [callback] - (err, output)\n * @returns {Promise<string>} - output code\n */\nfunction precompile(source, options, callback) {\n  if (typeof source === 'object' && typeof options === 'function') {\n    callback = options;\n    options = source;\n    source = options.source;\n  }\n\n  const promise = Promise.try(() => {\n    const opts = Object.assign({}, precompile.defaults, options);\n\n    if (typeof source !== 'string') {\n      throw Error('source must be a string');\n    }\n\n    // benchpress-rs doesn't support unsafe yet\n    const compiled = (opts.unsafe || opts.native === false ? compileFallback : compile)(\n      source,\n      opts\n    );\n    return opts.minify ? minify(compiled) : compiled;\n  });\n\n  if (callback) {\n    promise.then(\n      code => process.nextTick(callback, null, code),\n      err => process.nextTick(callback, err),\n    );\n  }\n\n  return promise;\n}\n\nprecompile.isNative = compile !== compileFallback;\n\nprecompile.defaults = {\n  minify: false,\n  unsafe: false,\n  native: true,\n};\n\nmodule.exports = precompile;\n"],"file":"precompile.js"}